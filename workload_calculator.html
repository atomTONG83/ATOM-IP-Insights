<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Brain-Burn Meter üî•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@700&display=swap');
        body { font-family: 'Inter', sans-serif; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .timer-font { font-family: 'Inter', sans-serif; letter-spacing: -0.02em; }
        
        /* Clear Mode Distinction */
        body.light { background-color: #f8fafc; color: #0f172a; }
        .light .glass { background: #ffffff; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .light input { background-color: #ffffff !important; color: #0f172a !important; border: 1px solid #cbd5e1 !important; }
        .light input::placeholder { color: #64748b; }
        .light #display { 
            color: #64748b; /* Sophisticated Gray */
            text-shadow: none; 
        }
        .light .stats-card { background: #ffffff; border: 2px solid #e2e8f0; }
        .light .stats-card span:first-child { color: #475569 !important; font-weight: 800; } /* Stats Label */
        .light .stats-card .text-3xl { color: #1e293b !important; } /* Stats Value */
        .light .text-dim { color: #475569; }
        .light .text-caption { color: #64748b; }

        body.dark { background-color: #1c1c1e; color: #f8fafc; }
        .dark .glass { background: rgba(44, 44, 46, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .dark input { background-color: #2c2c2e !important; color: #ffffff !important; border: 1px solid #3a3a3c !important; }
        .dark #display { 
            color: #94a3b8; /* Muted Apple Gray */
            text-shadow: 0 0 15px rgba(255,255,255,0.05); 
        }
        .dark .stats-card { background: #2c2c2e; border: 1px solid #3a3a3c; }
        .dark .text-dim { color: #cbd5e1; }
        .dark .record-title { color: #60a5fa; }
        
        /* Tactical Stop Button Enhancement */
        .btn-stop-tactical { background: #3f3f46; color: #fecaca; border: 1px solid #52525b; }
        .dark .btn-stop-tactical { background: #450a0a; color: #fecaca; border: 1px solid #7f1d1d; }
        
        /* Mobile App Scaling */
        @media (max-width: 640px) {
            #display { font-size: 6.5rem !important; }
            input { font-size: 1rem !important; padding-top: 0.75rem !important; padding-bottom: 0.75rem !important; }
            .btn-text { font-size: 0.85rem !important; }
            .record-title { font-size: 1rem !important; }
            .record-content { font-size: 0.85rem !important; }
        }

        .safe-bottom { padding-bottom: calc(20px + env(safe-area-inset-bottom)); }
        .safe-top { padding-top: calc(35px + env(safe-area-inset-top)); }
        @keyframes pulse-red { 0%, 100% { } 50% { background-color: rgba(239, 68, 68, 0.1); } }
        .pomodoro-end { animation: pulse-red 1s infinite; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Blinking Colon when running */
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }
        .running .colon { animation: blink 1s infinite; }
    </style>
</head>
<body class="light bg-slate-50 dark:bg-slate-900 min-h-screen flex flex-col no-scrollbar">

    <!-- Top Navigation Bar -->
    <nav class="safe-top sticky top-0 z-50 flex justify-between items-center px-6 py-4 glass shadow-sm">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center shadow-lg shadow-orange-500/30">
                <i class="fa-solid fa-fire-flame-curved text-white text-sm"></i>
            </div>
            <span class="font-bold text-slate-900 dark:text-white tracking-tight">Brain-Burn</span>
        </div>
        <div class="flex items-center gap-4">
            <button id="themeToggle" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-400 transition-all">
                <i id="themeIcon" class="fa-solid fa-moon"></i>
            </button>
            <a href="index.html" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-400">
                <i class="fa-solid fa-house"></i>
            </a>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-1 p-5 max-w-lg mx-auto w-full space-y-8">
        
        <!-- Timer Section (Hero) -->
        <section class="relative py-12 flex flex-col items-center justify-center px-6">
            <div id="live-clock" class="absolute top-2 text-[10px] font-bold text-slate-500 dark:text-slate-400 tracking-[0.3em] uppercase">2026-02-25 02:22:00</div>
            
            <div id="display" class="timer-font text-[6.5rem] font-black leading-none transition-all tracking-tight flex items-center">
                <span>00</span><span class="colon mx-1">:</span><span>00</span>
            </div>
            
            <div class="mt-4 flex items-center gap-2 px-4 py-1.5 bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-slate-400 rounded-full text-[10px] font-bold uppercase tracking-widest">
                <i class="fa-solid fa-fire animate-pulse text-orange-500"></i>
                Atom TONG Tactical
            </div>
        </section>

        <!-- Input Section -->
        <section class="space-y-3 px-2">
            <div class="relative">
                <i class="fa-solid fa-folder-open absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                <input type="text" id="case-number" placeholder="Ê°à‰ª∂ÁºñÂè∑ (Case #)" class="w-full pl-12 pr-4 py-3.5 rounded-2xl border-none ring-1 ring-slate-200 dark:ring-slate-800 bg-slate-50 dark:bg-slate-800 text-base font-bold outline-none transition-all focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="relative">
                <i class="fa-solid fa-pen-nib absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                <input type="text" id="work-content" placeholder="Â∑•‰ΩúÂÜÖÂÆπÊèèËø∞..." class="w-full pl-12 pr-4 py-3.5 rounded-2xl border-none ring-1 ring-slate-200 dark:ring-slate-800 bg-slate-50 dark:bg-slate-800 text-base font-bold outline-none transition-all focus:ring-2 focus:ring-blue-500">
            </div>
        </section>

        <!-- Action Grid -->
        <section class="grid grid-cols-2 gap-4">
            <button id="startBtn" class="flex flex-col items-center justify-center gap-3 bg-blue-600 text-white py-6 rounded-[2rem] font-bold shadow-2xl shadow-blue-600/30 active:scale-90 transition-all">
                <i class="fa-solid fa-play text-2xl"></i>
                <span class="text-sm uppercase tracking-wider btn-text">ÂºÄÂßãËÆ°Êó∂</span>
            </button>
            <button id="pauseBtn" class="hidden flex flex-col items-center justify-center gap-3 bg-orange-500 text-white py-6 rounded-[2rem] font-bold shadow-2xl shadow-orange-500/30 active:scale-90 transition-all">
                <i class="fa-solid fa-pause text-2xl"></i>
                <span class="text-sm uppercase tracking-wider btn-text">ÊöÇÊó∂ÂÅúÊ≠¢</span>
            </button>
            <button id="stopBtn" class="flex flex-col items-center justify-center gap-3 btn-stop-tactical py-6 rounded-[2rem] font-bold shadow-xl active:scale-90 transition-all">
                <i class="fa-solid fa-cloud-check text-2xl text-red-500"></i>
                <span class="text-sm uppercase tracking-wider btn-text">ÂÅúÊ≠¢‰øùÂ≠ò</span>
            </button>
            <button id="pomodoroBtn" class="col-span-2 flex items-center justify-center gap-4 bg-indigo-600 text-white py-5 rounded-3xl font-bold shadow-lg shadow-indigo-600/20 active:scale-95 transition-all">
                <i class="fa-solid fa-clock text-xl"></i>
                <span id="pomo-text" class="text-base font-bold uppercase tracking-widest">ÂºÄÂêØÁï™ËåÑ‰∏ìÊ≥® (30m)</span>
            </button>
        </section>

        <!-- Dynamic Stats Widgets -->
        <section class="grid grid-cols-2 gap-4">
            <div class="glass p-5 rounded-[2rem] flex flex-col items-start gap-1 shadow-sm stats-card">
                <span class="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-[0.2em]">Êú¨Âë®Â∑•Êó∂</span>
                <div class="flex items-baseline gap-1">
                    <span id="weekly-total" class="text-3xl font-black text-slate-900 dark:text-white">0.0</span>
                    <span class="text-xs text-slate-400 font-bold">H</span>
                </div>
            </div>
            <div class="glass p-5 rounded-[2rem] flex flex-col items-start gap-1 shadow-sm stats-card">
                <span class="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-[0.2em]">Êú¨ÊúàÊÄªËÆ°</span>
                <div class="flex items-baseline gap-1">
                    <span id="monthly-total" class="text-3xl font-black text-slate-900 dark:text-white">0.0</span>
                    <span class="text-xs text-slate-400 font-bold">H</span>
                </div>
            </div>
        </section>

        <!-- Mobile-first Records List -->
        <section class="space-y-5 pb-24">
            <div class="flex justify-between items-center px-2">
                <h2 class="text-lg font-black text-slate-900 dark:text-white tracking-tight">ÊúÄËøëËÆ∞ÂΩï</h2>
                <div class="relative">
                    <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                    <input type="text" id="historySearch" placeholder="ÊêúÁ¥¢..." class="pl-9 pr-4 py-2 bg-slate-200/50 dark:bg-slate-800 text-sm rounded-full outline-none focus:ring-2 focus:ring-blue-500 w-32 font-bold transition-all">
                </div>
            </div>
            
            <div id="history-list" class="space-y-3"></div>
            <div id="showAllContainer" class="hidden">
                <button id="showAllBtn" class="w-full py-4 text-sm font-black text-slate-400 dark:text-slate-500 bg-slate-100/50 dark:bg-slate-800/30 rounded-2xl border-2 border-dashed border-slate-200 dark:border-slate-800">Âä†ËΩΩÊõ¥Êó©ÁöÑÂéÜÂè≤ËÆ∞ÂΩï</button>
            </div>
        </section>
    </main>

    <!-- Footer Copyright -->
    <footer class="text-center py-6 text-[10px] text-slate-400 safe-bottom">
        &copy; 2026 ATOM TONG ÁâàÊùÉÊâÄÊúâ ¬∑ PI POWERED
    </footer>

    <script>
        const SUPABASE_URL = 'https://ghbmmnapyupusmyxjkvv.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_MkMhoECq7wo5qFi3K9Shcg_7LiPM1oU';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let startTime, elapsedTime = 0, timerInterval;
        let pomoInterval, pomoRemaining = 0, isPomoRunning = false;
        let history = [];
        let showAll = false;

        const display = document.getElementById('display');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const stopBtn = document.getElementById('stopBtn');
        const pomoBtn = document.getElementById('pomodoroBtn');
        const pomoText = document.getElementById('pomo-text');
        const historyList = document.getElementById('history-list');
        const historySearch = document.getElementById('historySearch');

        async function loadData() {
            try {
                const { data, error } = await supabaseClient.from('workload_records').select('*').order('timestamp', { ascending: false }).limit(showAll ? 100 : 15);
                if (data) { history = data; updateUI(); }
            } catch (e) { console.error(e); }
        }

        function formatTime(ms) {
            let h = Math.floor(ms/3600000), m = Math.floor((ms%3600000)/60000), s = Math.floor((ms%60000)/1000);
            return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }

        function updateDisplay(ms) {
            let h = Math.floor(ms/3600000), m = Math.floor((ms%3600000)/60000);
            display.innerHTML = `<span>${h.toString().padStart(2,'0')}</span><span class="colon mx-1">:</span><span>${m.toString().padStart(2,'0')}</span>`;
        }

        startBtn.onclick = () => {
            if (timerInterval) return;
            startTime = Date.now() - elapsedTime;
            timerInterval = setInterval(() => { 
                elapsedTime = Date.now() - startTime; 
                updateDisplay(elapsedTime); 
            }, 100);
            display.classList.add('running');
            startBtn.classList.add('hidden'); pauseBtn.classList.remove('hidden');
            if (isPomoRunning && !pomoInterval) startPomoTicker();
        };

        pauseBtn.onclick = () => { 
            clearInterval(timerInterval); 
            timerInterval = null; 
            clearInterval(pomoInterval); 
            pomoInterval = null; 
            display.classList.remove('running');
            startBtn.classList.remove('hidden'); 
            pauseBtn.classList.add('hidden'); 
        };

        stopBtn.onclick = async () => {
            if (elapsedTime === 0 && !isPomoRunning) return;
            clearInterval(timerInterval); timerInterval = null; clearInterval(pomoInterval); pomoInterval = null;
            display.classList.remove('running');
            
            const quarterHours = Math.max(1, Math.round((elapsedTime / 60000) / 15)) * 0.25;
            const record = {
                timestamp: Date.now(),
                date: new Date().toISOString().split('T')[0],
                case_number: document.getElementById('case-number').value || "MOBILE",
                content: (isPomoRunning ? "[Áï™ËåÑ] " : "") + (document.getElementById('work-content').value || "Êú™ÂÆö‰πâ‰ªªÂä°"),
                duration_hours: quarterHours
            };

            const { error } = await supabaseClient.from('workload_records').insert([record]);
            if (!error) { history.unshift(record); updateUI(); }
            
            elapsedTime = 0; 
            updateDisplay(0);
            isPomoRunning = false; pomoText.textContent = "ÂêØÂä®Áï™ËåÑ‰∏ìÊ≥® (30m)";
            startBtn.classList.remove('hidden'); pauseBtn.classList.add('hidden');
        };

        pomoBtn.onclick = () => {
            if (isPomoRunning) { clearInterval(pomoInterval); pomoInterval = null; isPomoRunning = false; pomoText.textContent = "ÂêØÂä®Áï™ËåÑ‰∏ìÊ≥® (30m)"; return; }
            pomoRemaining = 30 * 60; isPomoRunning = true; startPomoTicker(); startBtn.onclick();
        };

        function startPomoTicker() {
            if (pomoInterval) clearInterval(pomoInterval);
            pomoInterval = setInterval(() => {
                pomoRemaining--;
                let m = Math.floor(pomoRemaining / 60), s = pomoRemaining % 60;
                pomoText.textContent = `‰∏ìÊ≥®‰∏≠: ${m}:${s.toString().padStart(2,'0')}`;
                if (pomoRemaining <= 0) {
                    clearInterval(pomoInterval); pomoInterval = null; isPomoRunning = false;
                    pomoText.textContent = "‰∏ìÊ≥®ÂÆåÊàê! üçé";
                    document.body.classList.add('pomodoro-end');
                    setTimeout(() => document.body.classList.remove('pomodoro-end'), 5000);
                }
            }, 1000);
        }

        function updateUI() {
            historyList.innerHTML = '';
            const searchTerm = historySearch.value.toLowerCase();
            let week = 0, month = 0, now = new Date();
            let startW = new Date(now.setDate(now.getDate() - now.getDay())).toISOString().split('T')[0];
            let startM = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];

            history.filter(r => (r.case_number||"").toLowerCase().includes(searchTerm)).forEach(r => {
                const item = document.createElement('div');
                item.className = "glass p-5 rounded-[2rem] flex justify-between items-center shadow-sm";
                item.innerHTML = `
                    <div class="flex flex-col gap-1">
                        <span class="text-[9px] text-slate-500 dark:text-slate-400 font-black uppercase tracking-wider">${r.date}</span>
                        <span class="text-base font-black text-blue-700 dark:text-blue-400 record-title">${r.case_number}</span>
                        <span class="text-xs text-slate-700 dark:text-slate-400 font-medium record-content line-clamp-1">${r.content || ''}</span>
                    </div>
                    <div class="flex items-center gap-5">
                        <div class="text-right">
                            <span class="text-lg font-black text-slate-900 dark:text-white">${r.duration_hours.toFixed(2)}</span>
                            <span class="text-[9px] font-black text-slate-500 dark:text-slate-400">H</span>
                        </div>
                        <button onclick="delRec(${r.timestamp})" class="w-10 h-10 rounded-full flex items-center justify-center bg-slate-200 dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:text-red-500 transition-colors">
                            <i class="fa-solid fa-trash-can text-xs"></i>
                        </button>
                    </div>
                `;
                historyList.appendChild(item);
                if (r.date >= startW) week += r.duration_hours;
                if (r.date >= startM) month += r.duration_hours;
            });
            document.getElementById('weekly-total').textContent = week.toFixed(1);
            document.getElementById('monthly-total').textContent = month.toFixed(1);
        }

        window.delRec = async (ts) => {
            if (!confirm("Âà†Èô§ËÆ∞ÂΩï?")) return;
            const { error } = await supabaseClient.from('workload_records').delete().eq('timestamp', ts);
            if (!error) { history = history.filter(i => i.timestamp !== ts); updateUI(); }
        };

        const themeBtn = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        themeBtn.onclick = () => {
            const isDark = document.body.classList.contains('dark');
            document.body.classList.toggle('dark', !isDark);
            document.body.classList.toggle('light', isDark);
            themeIcon.className = isDark ? 'fa-solid fa-moon text-slate-400' : 'fa-solid fa-sun text-yellow-400';
            localStorage.setItem('web_theme', !isDark ? 'dark' : 'light');
        };
        if (localStorage.getItem('web_theme') === 'dark') themeBtn.onclick();

        historySearch.oninput = () => updateUI();
        setInterval(() => document.getElementById('live-clock').textContent = new Date().toLocaleString(), 1000);
        loadData();
    </script>
</body>
</html>
