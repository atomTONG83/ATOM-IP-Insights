<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brain-Burn Meter ğŸ”¥ - Atom TONG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; transition: all 0.3s; }
        
        /* Light Mode (Default) */
        body.light { background-color: #f1f5f9; color: #1e293b; }
        .light .glass { background: rgba(255, 255, 255, 0.98); border: 1px solid #e2e8f0; }
        .light .text-main { color: #0f172a; }
        .light .text-dim { color: #64748b; }
        .light .bg-sub { background-color: #f8fafc; }
        
        /* Dark Mode */
        body.dark { background-color: #0f172a; color: #f1f5f9; }
        .dark .glass { background: rgba(30, 41, 59, 0.95); border: 1px solid #334155; }
        .dark .text-main { color: #f8fafc; }
        .dark .text-dim { color: #94a3b8; }
        .dark .bg-sub { background-color: #1e293b; }
        .dark input { background-color: #1e293b !important; color: white; border-color: #334155 !important; }
        .dark #display { color: #38bdf8; }
        .dark .card:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }
        .dark thead { background-color: #1e293b !important; color: #94a3b8 !important; }
        .dark tr:hover { background-color: #334155 !important; }

        .timer-glow { text-shadow: 0 0 10px rgba(59, 130, 246, 0.2); }
        .card { transition: all 0.2s; }
        @keyframes pulse-red { 0%, 100% { } 50% { background-color: rgba(239, 68, 68, 0.2); } }
        .pomodoro-end { animation: pulse-red 1s infinite; }
        @keyframes confetti { 0% { transform: translateY(0) rotate(0); opacity: 1; } 100% { transform: translateY(100vh) rotate(360deg); opacity: 0; } }
        .confetti { position: fixed; width: 10px; height: 10px; z-index: 1000; pointer-events: none; animation: confetti 3s ease-out forwards; }
    </style>
</head>
<body class="p-4 flex flex-col items-center light">
    <div class="w-full max-w-2xl">
        <!-- Compact Header -->
        <header class="flex justify-between items-end mb-4 px-2">
            <div>
                <h1 class="text-xl font-bold text-main flex items-center gap-2">
                    <i class="fa-solid fa-fire-flame-curved text-orange-500"></i>
                    è„‘åŠ›è®¡è´¹å™¨ <span class="text-sm font-light opacity-50">Brain-Burn Meter</span>
                </h1>
                <p class="text-[10px] text-dim uppercase tracking-widest font-bold">Atom TONG Tactical Edition</p>
            </div>
            <div class="flex items-center gap-4">
                <button id="themeToggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                    <i id="themeIcon" class="fa-solid fa-moon"></i>
                </button>
                <div id="live-clock" class="text-xs font-mono text-dim"></div>
            </div>
        </header>

        <!-- Main Controller -->
        <div class="glass p-5 rounded-2xl shadow-sm mb-4">
            <div class="grid grid-cols-2 gap-3 mb-4">
                <input type="text" id="case-number" placeholder="æ¡ˆå·" class="px-3 py-2 text-sm rounded-lg border border-slate-200 focus:ring-1 focus:ring-blue-500 outline-none bg-slate-50/50">
                <input type="text" id="work-content" placeholder="å·¥ä½œå†…å®¹" class="px-3 py-2 text-sm rounded-lg border border-slate-200 focus:ring-1 focus:ring-blue-500 outline-none bg-slate-50/50">
            </div>

            <div class="flex flex-col items-center">
                <div id="display" class="text-5xl font-mono font-bold text-main timer-glow mb-5">00:00:00</div>
                
                <div class="flex flex-wrap justify-center gap-2 w-full">
                    <button id="startBtn" class="flex-1 bg-blue-600 text-white py-2.5 rounded-xl font-bold hover:bg-blue-700 active:scale-95 transition-all text-sm flex items-center justify-center gap-2">
                        <i class="fa-solid fa-play"></i> å¼€å§‹
                    </button>
                    <button id="pauseBtn" class="flex-1 bg-amber-500 text-white py-2.5 rounded-xl font-bold hover:bg-amber-600 active:scale-95 transition-all text-sm flex items-center justify-center gap-2 hidden">
                        <i class="fa-solid fa-pause"></i> æš‚åœ
                    </button>
                    <button id="stopBtn" class="flex-1 bg-red-500 text-white py-2.5 rounded-xl font-bold hover:bg-red-600 active:scale-95 transition-all text-sm flex items-center justify-center gap-2">
                        <i class="fa-solid fa-square"></i> åœæ­¢å¹¶ä¿å­˜
                    </button>
                    <button id="pomodoroBtn" class="flex-1 bg-indigo-50 text-indigo-600 py-2.5 rounded-xl font-bold border border-indigo-100 hover:bg-indigo-100 active:scale-95 transition-all text-sm flex items-center justify-center gap-2 min-w-[120px]">
                        <i class="fa-solid fa-apple-whole"></i> <span id="pomo-text">ç•ªèŒ„é’Ÿ (30m)</span>
                    </button>
                    <button id="reset" class="px-4 bg-slate-100 text-slate-500 py-2.5 rounded-xl text-sm font-semibold hover:bg-slate-200">
                        é‡ç½®
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="glass p-3 rounded-xl card flex justify-between items-center">
                <span class="text-[10px] font-bold text-dim uppercase">æœ¬å‘¨</span>
                <span id="weekly-total" class="font-bold text-main text-sm">0.0 h</span>
            </div>
            <div class="glass p-3 rounded-xl card flex justify-between items-center">
                <span class="text-[10px] font-bold text-dim uppercase">æœ¬æœˆ</span>
                <span id="monthly-total" class="font-bold text-main text-sm">0.0 h</span>
            </div>
        </div>

        <!-- History -->
        <div class="glass rounded-2xl shadow-sm overflow-hidden mb-8">
            <div class="px-4 py-3 border-b border-slate-50 flex justify-between items-center bg-sub">
                <div class="flex items-center gap-4">
                    <h2 class="text-sm font-bold text-main">æœ€è¿‘è®°å½•</h2>
                    <input type="text" id="historySearch" placeholder="æœç´¢æ¡ˆå·æˆ–å†…å®¹..." class="px-3 py-1 text-[10px] rounded-full border border-slate-200 outline-none focus:ring-1 focus:ring-blue-500 bg-white/50 w-40">
                </div>
                <div class="flex gap-3" id="admin-tools" style="display: none;">
                    <button id="cloudSyncBtn" class="text-[10px] font-bold text-orange-500 hover:text-orange-600 flex items-center gap-1">
                        <i class="fa-solid fa-cloud-arrow-down"></i> åŒæ­¥äº‘ç«¯
                    </button>
                    <button onclick="exportCSV()" class="text-[10px] font-bold text-blue-500 hover:underline">å¯¼å‡º CSV</button>
                </div>
            </div>
            <div class="max-h-60 overflow-y-auto">
                <table class="w-full text-left text-xs">
                    <thead class="sticky top-0 bg-white shadow-sm">
                        <tr class="text-slate-400 font-bold uppercase">
                            <th class="px-4 py-2">æ—¥æœŸ</th>
                            <th class="px-4 py-2">æ¡ˆå·</th>
                            <th class="px-4 py-2">å†…å®¹</th>
                            <th class="px-4 py-2 text-right">å·¥æ—¶</th>
                            <th class="px-4 py-2 text-center">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="history-body" class="divide-y divide-slate-50"></tbody>
                </table>
            </div>
            <div id="showAllContainer" class="px-4 py-2 text-center bg-slate-50/50 border-t border-slate-50 hidden">
                <button id="showAllBtn" class="text-[10px] font-bold text-slate-400 hover:text-blue-500 transition-colors">æ˜¾ç¤ºå…¨éƒ¨è®°å½• (å±•å¼€å†å²)</button>
            </div>
        </div>

        <footer class="text-center text-[10px] text-slate-400 font-medium">
            &copy; 2026 Atom TONG ç‰ˆæƒæ‰€æœ‰
        </footer>
    </div>

    <script>
        let startTime, elapsedTime = 0, timerInterval;
        let pomoInterval, pomoRemaining = 0, isPomoRunning = false;
        let history = [];
        let showAll = false;

        const display = document.getElementById('display');
        const pomoText = document.getElementById('pomo-text');
        const pomoBtn = document.getElementById('pomodoroBtn');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const historyBody = document.getElementById('history-body');

        async function loadData() {
            try {
                // Cache-busting for Chrome
                const cacheBuster = '?_=' + Date.now();
                const res = await fetch('/memory/workload_data.json' + cacheBuster);
                if (res.ok) { 
                    history = await res.json(); 
                    // Also fetch deleted IDs and filter them out
                    try {
                        const delRes = await fetch('/memory/deleted_workload_ids.json' + cacheBuster);
                        if (delRes.ok) {
                            const deletedIds = await delRes.json();
                            history = history.filter(r => !deletedIds.includes(r.timestamp));
                        }
                    } catch (e) {}
                    updateUI(); 
                }
            } catch (e) {}
        }

        function formatTime(ms) {
            let h = Math.floor(ms / 3600000), m = Math.floor((ms % 3600000) / 60000), s = Math.floor((ms % 60000) / 1000);
            return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }

        startBtn.onclick = () => {
            if (timerInterval) return;
            startTime = Date.now() - elapsedTime;
            timerInterval = setInterval(() => {
                elapsedTime = Date.now() - startTime;
                display.textContent = formatTime(elapsedTime);
            }, 100);
            startBtn.classList.add('hidden');
            pauseBtn.classList.remove('hidden');
            if (isPomoRunning && !pomoInterval) startPomoTicker();
        };

        pauseBtn.onclick = () => {
            clearInterval(timerInterval); timerInterval = null;
            clearInterval(pomoInterval); pomoInterval = null;
            startBtn.classList.remove('hidden');
            pauseBtn.classList.add('hidden');
        };

        document.getElementById('stopBtn').onclick = async () => {
            if (elapsedTime === 0 && !isPomoRunning) return;
            clearInterval(timerInterval); timerInterval = null;
            clearInterval(pomoInterval); pomoInterval = null;
            isPomoRunning = false;
            pomoText.textContent = "ç•ªèŒ„é’Ÿ (30m)";
            startBtn.classList.remove('hidden');
            pauseBtn.classList.add('hidden');
            
            const caseNum = document.getElementById('case-number').value || "æ— æ¡ˆå·";
            const content = document.getElementById('work-content').value || "å¸¸è§„å·¥ä½œ";
            const quarterHours = Math.max(1, Math.round((elapsedTime / 60000) / 15)) * 0.25;

            const record = {
                date: new Date().toISOString().split('T')[0],
                timestamp: Date.now(),
                case_number: caseNum,
                content: content,
                duration_hours: quarterHours,
                duration_formatted: quarterHours.toFixed(2) + " h"
            };

            await fetch('/save_workload', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(record) });
            history.push(record);
            elapsedTime = 0; 
            display.textContent = "00:00:00";
            document.getElementById('case-number').value = "";
            document.getElementById('work-content').value = "";
            updateUI();
        };

        pomoBtn.onclick = () => {
            if (isPomoRunning) { 
                clearInterval(pomoInterval); pomoInterval = null; 
                isPomoRunning = false; pomoText.textContent = "ç•ªèŒ„é’Ÿ (30m)"; 
                return; 
            }
            pomoRemaining = 30 * 60;
            isPomoRunning = true;
            startPomoTicker();
            startBtn.click();
        };

        function startPomoTicker() {
            if (pomoInterval) clearInterval(pomoInterval);
            pomoInterval = setInterval(() => {
                pomoRemaining--;
                let m = Math.floor(pomoRemaining / 60), s = pomoRemaining % 60;
                pomoText.textContent = `${m}:${s.toString().padStart(2,'0')}`;
                if (pomoRemaining <= 0) {
                    clearInterval(pomoInterval); pomoInterval = null;
                    isPomoRunning = false;
                    pomoText.textContent = "DONE! ğŸ";
                    triggerEndEffect();
                }
            }, 1000);
        }

        document.getElementById('reset').onclick = () => {
            clearInterval(timerInterval); timerInterval = null;
            clearInterval(pomoInterval); pomoInterval = null;
            isPomoRunning = false;
            elapsedTime = 0; display.textContent = "00:00:00";
            pomoText.textContent = "ç•ªèŒ„é’Ÿ (30m)";
            startBtn.classList.remove('hidden');
            pauseBtn.classList.add('hidden');
        };

        function updateUI() {
            historyBody.innerHTML = '';
            const searchTerm = document.getElementById('historySearch').value.toLowerCase();
            const today = new Date().toISOString().split('T')[0];
            let week = 0, month = 0, now = new Date();
            let startW = new Date(now.setDate(now.getDate() - now.getDay())).toISOString().split('T')[0];
            let startM = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];

            let filtered = history.filter(r => 
                (r.case_number || "").toLowerCase().includes(searchTerm) || 
                (r.content || "").toLowerCase().includes(searchTerm)
            ).reverse();

            // æŒ‰æ—¥æœŸåˆ†ç»„
            const groups = {};
            filtered.forEach(r => {
                if (!groups[r.date]) groups[r.date] = [];
                groups[r.date].push(r);
            });

            const sortedDates = Object.keys(groups).sort().reverse();

            sortedDates.forEach(date => {
                const isToday = (date === today);
                const dayRecords = groups[date];
                const dayTotal = dayRecords.reduce((sum, r) => sum + r.duration_hours, 0);

                if (isToday || showAll) {
                    // æ¸²æŸ“æ—¥æœŸæ ‡é¢˜è¡Œï¼ˆä»…åœ¨éä»Šæ—¥æˆ–showAllæ¨¡å¼ä¸‹æ˜¾ç¤ºæ ‡é¢˜ï¼Œä»Šæ—¥è®°å½•ç›´æ¥æ˜¾ç¤ºæ˜ç»†ï¼‰
                    if (!isToday) {
                        const headerTr = document.createElement('tr');
                        headerTr.className = "bg-slate-50/80 font-bold dark:bg-slate-800/50";
                        headerTr.innerHTML = `
                            <td colspan="5" class="px-4 py-2 text-main flex justify-between items-center cursor-pointer" onclick="this.parentElement.nextElementSibling.classList.toggle('hidden')">
                                <span>ğŸ“… ${date}</span>
                                <span class="text-[10px] text-blue-500">å½“æ—¥æ€»è®¡: ${dayTotal.toFixed(2)} h</span>
                            </td>
                        `;
                        // historyBody.appendChild(headerTr); // è¿™ç§é€»è¾‘ç•¥å¤æ‚ï¼Œæ”¹ç”¨æ›´ç›´æ¥çš„æ¸²æŸ“
                    }

                    dayRecords.forEach(r => {
                        const tr = document.createElement('tr');
                        if (isToday) tr.className = "bg-blue-50/30 dark:bg-blue-900/10";
                        tr.innerHTML = `
                            <td class="px-4 py-2 text-dim font-medium">${isToday ? '<span class="text-blue-500">ä»Šæ—¥</span>' : r.date}</td>
                            <td class="px-4 py-2 font-bold text-blue-500">${r.case_number}</td>
                            <td class="px-4 py-2 text-dim truncate max-w-[150px]">${r.content}</td>
                            <td class="px-4 py-2 text-right font-mono font-bold text-main">${r.duration_hours.toFixed(2)}</td>
                            <td class="px-4 py-2 text-center">
                                <button onclick="editRec(${r.timestamp})" class="text-slate-300 hover:text-blue-500 mr-2"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="delRec(${r.timestamp})" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        `;
                        historyBody.appendChild(tr);
                    });
                } else {
                    // æ¸²æŸ“æŠ˜å è¡Œï¼ˆå†å²è®°å½•èšåˆï¼‰
                    const summaryTr = document.createElement('tr');
                    summaryTr.className = "hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors";
                    summaryTr.innerHTML = `
                        <td class="px-4 py-3 text-dim font-bold">ğŸ“… ${date}</td>
                        <td colspan="2" class="px-4 py-3 text-[10px] text-slate-400 italic">å…± ${dayRecords.length} é¡¹å·¥ä½œè®°å½•</td>
                        <td class="px-4 py-3 text-right font-mono font-bold text-blue-500">${dayTotal.toFixed(2)} h</td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="showAll=true; updateUI();" class="text-blue-400 hover:text-blue-600 text-[10px] font-bold">å±•å¼€è¯¦æƒ…</button>
                        </td>
                    `;
                    historyBody.appendChild(summaryTr);
                }
            });

            if (!showAll && sortedDates.length > 1) {
                document.getElementById('showAllContainer').classList.remove('hidden');
            } else {
                document.getElementById('showAllContainer').classList.add('hidden');
            }

            // Always calculate stats based on FULL history
            history.forEach(r => {
                if (r.date >= startW) week += r.duration_hours;
                if (r.date >= startM) month += r.duration_hours;
            });
            
            document.getElementById('weekly-total').textContent = week.toFixed(1) + ' h';
            document.getElementById('monthly-total').textContent = month.toFixed(1) + ' h';
        }

        document.getElementById('historySearch').oninput = () => updateUI();
        document.getElementById('showAllBtn').onclick = () => { showAll = true; updateUI(); };

        window.editRec = async (ts) => {
            const r = history.find(i => i.timestamp === ts);
            const nCase = prompt("æ¡ˆå·:", r.case_number), nCont = prompt("å†…å®¹:", r.content), nTime = prompt("ç”¨æ—¶ (å°æ—¶, 0.25 çš„å€æ•°):", r.duration_hours);
            if (nCase && nCont && nTime) {
                const res = await fetch('/update_workload', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({timestamp:ts, case_number:nCase, content:nCont, duration_hours:nTime})});
                if (res.ok) { r.case_number = nCase; r.content = nCont; r.duration_hours = parseFloat(nTime); updateUI(); }
            }
        };

        window.delRec = async (ts) => {
            if (confirm("åˆ é™¤?")) {
                const res = await fetch('/delete_workload', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({timestamp:ts})});
                if (res.ok) { history = history.filter(i => i.timestamp !== ts); updateUI(); }
            }
        };

        setInterval(() => document.getElementById('live-clock').textContent = new Date().toLocaleString(), 1000);

        // Theme Toggle Logic
        const themeBtn = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const cloudSyncBtn = document.getElementById('cloudSyncBtn');

        cloudSyncBtn.onclick = async () => {
            cloudSyncBtn.disabled = true;
            cloudSyncBtn.innerHTML = '<i class="fa-solid fa-spinner animate-spin"></i> åŒæ­¥ä¸­...';
            try {
                const res = await fetch('/sync_cloud_workload', { method: 'POST' });
                if (res.ok) {
                    const data = await res.json();
                    alert("åŒæ­¥å®Œæˆï¼å·²ä»äº‘ç«¯æ‹‰å–æœ€æ–°è®°å½•ã€‚");
                    loadData(); // Reload history
                } else {
                    alert("åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æ—¥å¿—ã€‚");
                }
            } catch (e) {
                alert("åŒæ­¥è¯·æ±‚å‡ºé”™: " + e.message);
            } finally {
                cloudSyncBtn.disabled = false;
                cloudSyncBtn.innerHTML = '<i class="fa-solid fa-cloud-arrow-down"></i> åŒæ­¥äº‘ç«¯';
            }
        };
        
        function setTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.replace('light', 'dark');
                themeIcon.className = 'fa-solid fa-sun text-yellow-400';
            } else {
                document.body.classList.replace('dark', 'light');
                themeIcon.className = 'fa-solid fa-moon text-slate-400';
            }
            localStorage.setItem('theme', theme);
        }

        themeBtn.onclick = () => {
            const current = document.body.classList.contains('dark') ? 'light' : 'dark';
            setTheme(current);
        };

        // Export CSV Function
        window.exportCSV = () => {
            if (history.length === 0) {
                alert("æ²¡æœ‰è®°å½•å¯å¯¼å‡º");
                return;
            }
            
            // CSV Header
            let csv = '\uFEFFæ—¥æœŸ,æ—¶é—´æˆ³,æ¡ˆå·,å·¥ä½œå†…å®¹,å·¥æ—¶(å°æ—¶)\n';
            
            // Add data rows
            history.forEach(r => {
                const date = r.date || new Date(r.timestamp).toISOString().split('T')[0];
                const caseNum = (r.case_number || '').replace(/,/g, ';');
                const content = (r.content || '').replace(/,/g, ';').replace(/\n/g, ' ');
                const hours = r.duration_hours ? r.duration_hours.toFixed(2) : '0.00';
                csv += `${date},${r.timestamp},"${caseNum}","${content}",${hours}\n`;
            });
            
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const timestamp = new Date().toISOString().split('T')[0];
            link.href = URL.createObjectURL(blob);
            link.download = `workload_records_${timestamp}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`å·²å¯¼å‡º ${history.length} æ¡è®°å½•åˆ° CSV`);
        };

        // Init theme
        const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        setTheme(savedTheme);

        // ç¯å¢ƒæ£€æµ‹ä¸å·¥å…·æ˜¾ç¤ºé€»è¾‘
        const isLocal = window.location.hostname === 'localhost' || 
                        window.location.hostname === '127.0.0.1' || 
                        window.location.hostname === '192.168.32.70';
        
        if (isLocal) {
            document.getElementById('admin-tools').style.display = 'flex';
        }

        loadData();
    </script>
</body>
</html>
