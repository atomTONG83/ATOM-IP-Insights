<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Brain-Burn Meter ğŸ”¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@700&display=swap');
        body { font-family: 'Inter', sans-serif; transition: all 0.3s; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .timer-font { font-family: 'JetBrains Mono', monospace; letter-spacing: -0.05em; }
        
        /* Glassmorphism Refined */
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .dark .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        
        /* Mobile App Feel */
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .safe-top { padding-top: env(safe-area-inset-top); }
        
        @keyframes pulse-red { 0%, 100% { background-color: transparent; } 50% { background-color: rgba(239, 68, 68, 0.15); } }
        .pomodoro-end { animation: pulse-red 1s infinite; }
        
        input::placeholder { color: #94a3b8; font-weight: 400; }
        .dark input { color: white; }
        
        /* Hide scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Button Glows */
        .btn-active-blue { box-shadow: 0 0 20px rgba(37, 99, 235, 0.3); }
        .btn-active-pomo { box-shadow: 0 0 20px rgba(99, 102, 241, 0.3); }
    </style>
</head>
<body class="light bg-slate-50 dark:bg-slate-900 min-h-screen flex flex-col no-scrollbar">

    <!-- Top Navigation Bar -->
    <nav class="safe-top sticky top-0 z-50 flex justify-between items-center px-6 py-4 glass shadow-sm">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center shadow-lg shadow-orange-500/30">
                <i class="fa-solid fa-fire-flame-curved text-white text-sm"></i>
            </div>
            <span class="font-bold text-slate-900 dark:text-white tracking-tight">Brain-Burn</span>
        </div>
        <div class="flex items-center gap-4">
            <button id="themeToggle" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 transition-all">
                <i id="themeIcon" class="fa-solid fa-moon"></i>
            </button>
            <a href="index.html" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400">
                <i class="fa-solid fa-house"></i>
            </a>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-1 p-5 max-w-lg mx-auto w-full space-y-6">
        
        <!-- Timer Section (Hero) -->
        <section class="relative py-10 flex flex-col items-center justify-center">
            <div id="live-clock" class="absolute top-0 text-[10px] font-mono text-slate-400 dark:text-slate-600 tracking-widest uppercase">2026-02-25 02:22:00</div>
            
            <div id="display" class="timer-font text-[5.5rem] font-bold text-slate-900 dark:text-blue-400 drop-shadow-sm leading-none transition-all">00:00:00</div>
            
            <div class="mt-4 flex items-center gap-2 px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full text-[10px] font-bold uppercase tracking-widest">
                <i class="fa-solid fa-bolt-lightning animate-pulse"></i>
                Atom TONG Edition
            </div>
        </section>

        <!-- Input Section (Stacked for Mobile) -->
        <section class="space-y-3">
            <div class="relative">
                <i class="fa-solid fa-folder-open absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                <input type="text" id="case-number" placeholder="è¾“å…¥æ¡ˆä»¶ç¼–å·..." class="w-full pl-10 pr-4 py-4 rounded-2xl border-none ring-1 ring-slate-200 dark:ring-slate-800 bg-white dark:bg-slate-800 text-slate-900 dark:text-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all text-sm font-semibold">
            </div>
            <div class="relative">
                <i class="fa-solid fa-pen-nib absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                <input type="text" id="work-content" placeholder="æ­£åœ¨åšä»€ä¹ˆå·¥ä½œ..." class="w-full pl-10 pr-4 py-4 rounded-2xl border-none ring-1 ring-slate-200 dark:ring-slate-800 bg-white dark:bg-slate-800 text-slate-900 dark:text-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all text-sm font-semibold">
            </div>
        </section>

        <!-- Action Grid -->
        <section class="grid grid-cols-2 gap-3">
            <button id="startBtn" class="flex flex-col items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white py-5 rounded-3xl font-bold shadow-xl shadow-blue-600/20 active:scale-95 transition-all">
                <i class="fa-solid fa-play text-xl"></i>
                <span class="text-xs uppercase tracking-wider">å¼€å§‹ä»»åŠ¡</span>
            </button>
            <button id="pauseBtn" class="hidden flex flex-col items-center justify-center gap-2 bg-amber-500 hover:bg-amber-600 text-white py-5 rounded-3xl font-bold shadow-xl shadow-amber-500/20 active:scale-95 transition-all">
                <i class="fa-solid fa-pause text-xl"></i>
                <span class="text-xs uppercase tracking-wider">æš‚æ—¶ç¦»å¼€</span>
            </button>
            <button id="stopBtn" class="flex flex-col items-center justify-center gap-2 bg-slate-900 dark:bg-white text-white dark:text-slate-900 py-5 rounded-3xl font-bold shadow-xl active:scale-95 transition-all">
                <i class="fa-solid fa-cloud-arrow-up text-xl"></i>
                <span class="text-xs uppercase tracking-wider">åœæ­¢ä¿å­˜</span>
            </button>
            <button id="pomodoroBtn" class="col-span-2 flex items-center justify-center gap-3 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400 py-4 rounded-2xl font-bold border border-indigo-100 dark:border-indigo-900/50 active:scale-95 transition-all">
                <i class="fa-solid fa-apple-whole text-lg"></i>
                <span id="pomo-text" class="text-sm font-bold uppercase tracking-widest">å¯åŠ¨ç•ªèŒ„ä¸“æ³¨ (30m)</span>
            </button>
        </section>

        <!-- Dynamic Stats Widgets -->
        <section class="grid grid-cols-2 gap-3">
            <div class="glass p-4 rounded-3xl flex flex-col items-start gap-1">
                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">æœ¬å‘¨æ¶ˆè€—è„‘åŠ›</span>
                <div class="flex items-baseline gap-1">
                    <span id="weekly-total" class="text-xl font-bold text-slate-900 dark:text-white">0.0</span>
                    <span class="text-[10px] text-slate-400 font-bold">H</span>
                </div>
            </div>
            <div class="glass p-4 rounded-3xl flex flex-col items-start gap-1">
                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">æœ¬æœˆæ™ºåŠ›äº§å‡º</span>
                <div class="flex items-baseline gap-1">
                    <span id="monthly-total" class="text-xl font-bold text-slate-900 dark:text-white">0.0</span>
                    <span class="text-[10px] text-slate-400 font-bold">H</span>
                </div>
            </div>
        </section>

        <!-- Mobile-first Records List -->
        <section class="space-y-4 pb-20">
            <div class="flex justify-between items-center px-1">
                <h2 class="text-sm font-bold text-slate-900 dark:text-white">æœ€è¿‘è®°å½•</h2>
                <div class="relative">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-[10px]"></i>
                    <input type="text" id="historySearch" placeholder="æœç´¢æ¡ˆå·..." class="pl-8 pr-3 py-1.5 bg-slate-200/50 dark:bg-slate-800 text-[10px] rounded-full outline-none focus:ring-1 focus:ring-blue-500 w-28 font-medium">
                </div>
            </div>
            
            <div id="history-list" class="space-y-2">
                <!-- Mobile List Items Template -->
            </div>

            <div id="showAllContainer" class="hidden">
                <button id="showAllBtn" class="w-full py-3 text-[11px] font-bold text-slate-400 dark:text-slate-600 bg-white dark:bg-slate-800/50 rounded-xl border border-slate-200 dark:border-slate-800">æŸ¥çœ‹æ›´å¤šå†å²</button>
            </div>
        </section>
    </main>

    <!-- Footer Copyright -->
    <footer class="text-center py-6 text-[10px] text-slate-400 safe-bottom">
        &copy; 2026 ATOM TONG ç‰ˆæƒæ‰€æœ‰ Â· PI POWERED
    </footer>

    <script>
        const SUPABASE_URL = 'https://ghbmmnapyupusmyxjkvv.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_MkMhoECq7wo5qFi3K9Shcg_7LiPM1oU';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let startTime, elapsedTime = 0, timerInterval;
        let pomoInterval, pomoRemaining = 0, isPomoRunning = false;
        let history = [];
        let showAll = false;

        const display = document.getElementById('display');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const stopBtn = document.getElementById('stopBtn');
        const pomoBtn = document.getElementById('pomodoroBtn');
        const pomoText = document.getElementById('pomo-text');
        const historyList = document.getElementById('history-list');
        const historySearch = document.getElementById('historySearch');

        async function loadData() {
            try {
                const { data, error } = await supabaseClient.from('workload_records').select('*').order('timestamp', { ascending: false }).limit(showAll ? 100 : 15);
                if (data) { history = data; updateUI(); }
            } catch (e) { console.error(e); }
        }

        function formatTime(ms) {
            let h = Math.floor(ms/3600000), m = Math.floor((ms%3600000)/60000), s = Math.floor((ms%60000)/1000);
            return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }

        startBtn.onclick = () => {
            if (timerInterval) return;
            startTime = Date.now() - elapsedTime;
            timerInterval = setInterval(() => { elapsedTime = Date.now() - startTime; display.textContent = formatTime(elapsedTime); }, 100);
            startBtn.classList.add('hidden'); pauseBtn.classList.remove('hidden');
            if (isPomoRunning && !pomoInterval) startPomoTicker();
        };

        pauseBtn.onclick = () => { clearInterval(timerInterval); timerInterval = null; clearInterval(pomoInterval); pomoInterval = null; startBtn.classList.remove('hidden'); pauseBtn.classList.add('hidden'); };

        stopBtn.onclick = async () => {
            if (elapsedTime === 0 && !isPomoRunning) return;
            clearInterval(timerInterval); timerInterval = null; clearInterval(pomoInterval); pomoInterval = null;
            
            const quarterHours = Math.max(1, Math.round((elapsedTime / 60000) / 15)) * 0.25;
            const record = {
                timestamp: Date.now(),
                date: new Date().toISOString().split('T')[0],
                case_number: document.getElementById('case-number').value || "MOBILE",
                content: (isPomoRunning ? "[ç•ªèŒ„] " : "") + (document.getElementById('work-content').value || "æœªå®šä¹‰ä»»åŠ¡"),
                duration_hours: quarterHours
            };

            const { error } = await supabaseClient.from('workload_records').insert([record]);
            if (!error) { history.unshift(record); updateUI(); }
            
            elapsedTime = 0; display.textContent = "00:00:00";
            isPomoRunning = false; pomoText.textContent = "å¯åŠ¨ç•ªèŒ„ä¸“æ³¨ (30m)";
            startBtn.classList.remove('hidden'); pauseBtn.classList.add('hidden');
        };

        pomoBtn.onclick = () => {
            if (isPomoRunning) { clearInterval(pomoInterval); pomoInterval = null; isPomoRunning = false; pomoText.textContent = "å¯åŠ¨ç•ªèŒ„ä¸“æ³¨ (30m)"; return; }
            pomoRemaining = 30 * 60; isPomoRunning = true; startPomoTicker(); startBtn.onclick();
        };

        function startPomoTicker() {
            if (pomoInterval) clearInterval(pomoInterval);
            pomoInterval = setInterval(() => {
                pomoRemaining--;
                let m = Math.floor(pomoRemaining / 60), s = pomoRemaining % 60;
                pomoText.textContent = `ä¸“æ³¨ä¸­: ${m}:${s.toString().padStart(2,'0')}`;
                if (pomoRemaining <= 0) {
                    clearInterval(pomoInterval); pomoInterval = null; isPomoRunning = false;
                    pomoText.textContent = "ä¸“æ³¨å®Œæˆ! ğŸ";
                    document.body.classList.add('pomodoro-end');
                    setTimeout(() => document.body.classList.remove('pomodoro-end'), 5000);
                }
            }, 1000);
        }

        function updateUI() {
            historyList.innerHTML = '';
            const searchTerm = historySearch.value.toLowerCase();
            let week = 0, month = 0, now = new Date();
            let startW = new Date(now.setDate(now.getDate() - now.getDay())).toISOString().split('T')[0];
            let startM = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];

            history.filter(r => (r.case_number||"").toLowerCase().includes(searchTerm)).forEach(r => {
                const item = document.createElement('div');
                item.className = "glass p-4 rounded-2xl flex justify-between items-center";
                item.innerHTML = `
                    <div class="flex flex-col">
                        <span class="text-[9px] text-slate-400 font-bold uppercase">${r.date}</span>
                        <span class="text-sm font-bold text-blue-600 dark:text-blue-400">${r.case_number}</span>
                        <span class="text-[10px] text-slate-500 dark:text-slate-400 line-clamp-1">${r.content || ''}</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right">
                            <span class="text-sm font-bold dark:text-white">${r.duration_hours.toFixed(2)}</span>
                            <span class="text-[9px] font-bold text-slate-400">H</span>
                        </div>
                        <button onclick="delRec(${r.timestamp})" class="w-8 h-8 rounded-full flex items-center justify-center bg-slate-100 dark:bg-slate-800 text-slate-300 hover:text-red-500 transition-colors">
                            <i class="fa-solid fa-trash-can text-[10px]"></i>
                        </button>
                    </div>
                `;
                historyList.appendChild(item);
                if (r.date >= startW) week += r.duration_hours;
                if (r.date >= startM) month += r.duration_hours;
            });
            document.getElementById('weekly-total').textContent = week.toFixed(1);
            document.getElementById('monthly-total').textContent = month.toFixed(1);
        }

        window.delRec = async (ts) => {
            if (!confirm("åˆ é™¤è®°å½•?")) return;
            const { error } = await supabaseClient.from('workload_records').delete().eq('timestamp', ts);
            if (!error) { history = history.filter(i => i.timestamp !== ts); updateUI(); }
        };

        const themeBtn = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        themeBtn.onclick = () => {
            const isDark = document.body.classList.contains('dark');
            document.body.classList.toggle('dark', !isDark);
            document.body.classList.toggle('light', isDark);
            themeIcon.className = isDark ? 'fa-solid fa-moon text-slate-400' : 'fa-solid fa-sun text-yellow-400';
            localStorage.setItem('web_theme', !isDark ? 'dark' : 'light');
        };
        if (localStorage.getItem('web_theme') === 'dark') themeBtn.onclick();

        historySearch.oninput = () => updateUI();
        setInterval(() => document.getElementById('live-clock').textContent = new Date().toLocaleString(), 1000);
        loadData();
    </script>
</body>
</html>
